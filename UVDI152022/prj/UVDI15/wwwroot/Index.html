<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Monitoring Web Panel</title>
    <style>
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #007bff;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ccc;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #e0e0e0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background-color: #fff;
            border-bottom: 2px solid #fff;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background-color: #fff;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 0 0 5px 5px;
        }

        .tab-content.active {
            display: block;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
            border-left: 5px solid #007bff;
            padding-left: 10px;
            background-color: #e8f0fe;
        }

        #outputText {
            font-weight: bold;
            color: #555;
            white-space: pre;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
    <script src="/lib/signalr.min.js"></script>
<script>
    let connection;

    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                contents[index].classList.add('active');
            });
        });

        connection = new signalR.HubConnectionBuilder()
            .withUrl("/monitoringhub")
            .configureLogging(signalR.LogLevel.Information)
            .withAutomaticReconnect({
            nextRetryDelayInMilliseconds: retryContext => {
                if (retryContext.previousRetryCount < 1000) {
                    return 10000; // 10초마다 시도, 최대 1000번 (즉, 약 3시간 시도)
                }
                return null; // 포기
            }
        })
            .build();

        connection.on("ReceiveValues", (str) => {
            document.getElementById("MonValText").innerText = str;
        });

        connection.on("ReceiveLogs", (str) => {
            document.getElementById("LogText").innerText = str;
        });

        connection.on("ReceiveCmdLogs", (str) => {
            document.getElementById("CmdLogText").innerText = str;
        });


        connection.on("ReceiveConfigUpdate", (json) => {
        try {
            const items = JSON.parse(json); 
            if (!Array.isArray(items)) return;

            items.forEach(({ label, values }) => {
                console.log("📥 Received config update:", label, values);
                const configItem = document.querySelector(`.config-item[data-config-label="${label}"]`);
                if (configItem) {
                    const inputs = configItem.querySelectorAll("input");
                    if (inputs.length === values.length) {
                        for (let i = 0; i < inputs.length; i++) {
                            inputs[i].value = values[i];
                        }
                    } else {
                        console.warn(`Input count mismatch for ${label}`);
                    }
                } else {
                    console.warn(`No config item found for ${label}`);
                }
            });
        } catch (err) {
            console.error("Failed to handle config update:", err);
        }
    });

        connection.start()
            .then(() => {
                console.log('Connected to server');
                connection.invoke("RequestReset")
                    .catch(err => console.error('Failed to reset data:', err));

                connection.invoke("RequestRefreshValues")
                    .catch(err => console.error('Failed to request values:', err));
            })
            .catch(err => console.error('Could not connect to server:', err));

        document.getElementById("clearLogsButton")?.addEventListener("click", function () {
            connection.invoke("ClearLogs")
                .then(() => console.log('Logs cleared.'))
                .catch(err => console.error('Failed to clear logs:', err));
        });
    });


    function sendConfigUpdate(label, count) {
        const container = document.querySelector(`.config-item[data-config-label="${label}"]`);
        if (!container) return;

        const inputs = container.querySelectorAll('input');
        let values = [];
        inputs.forEach(input => values.push(input.value.trim()));

        if (inputs.length !== count) {
            console.warn(`Input count mismatch for ${label}`);
            return;
        }

        const msg = `config/${label}/${values.join('/')}`;
        sendCommand(msg);
    }

    function sendCommandWithParam(cmd) {
        const commonParam = document.getElementById("commonParam")?.value || "";
        const fullCmd = `cmd/${cmd}/${commonParam}`;
        connection.invoke("ReceiveCommand", fullCmd)
            .then(() => console.log(`Command sent: ${fullCmd}`))
            .catch(err => console.error(`Failed to send command: ${err}`));
    }

    function sendCommand(cmd) {
        if (!connection) {
            console.error("Connection is not initialized.");
            return;
        }

        connection.invoke("ReceiveCommand", `${cmd}` )
            .then(() => console.log(`Command sent: ${cmd}`))
            .catch(err => console.error(`Failed to send command: ${err}`));
    }
</script>
</head>
<body>
    <H1>Device Monitoring Web Panel</H1>
    <div class="tabs">
        <div class="tab active">Log</div>
        <div class="tab">Monitoring Values</div>
        <div class="tab">Control</div>
        <div class='tab'>Config</div>
        <div class="tab">Capture</div>
    </div>

    <div class="tab-content active">
    <div class="category-title">실시간 로그</div>
        <pre id="LogText"></pre>
        <button id="clearLogsButton">Clear Logs</button>
    </div>

    <div class="tab-content">
        <div class="category-title">모니터링 데이터</div>
        <pre id="MonValText"></pre>
    </div>

    <div class="tab-content">
        <div class="category-title">공통 파라메터</div>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="commonParam" placeholder="여기에 입력" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em;" />
        </div>
        <button onclick="sendCommandWithParam('_initAF')">af초기화</button>
        <button onclick="sendCommandWithParam('_internalLDS')">set internal</button>
        <button onclick="sendCommandWithParam('_externalLDS')">set external</button>
        <button onclick="sendCommandWithParam('_getLDStype')">센서타입 읽기</button>
        <button onclick="sendCommandWithParam('_IsldsOn')">센서 on/off상태</button>
        <button onclick="sendCommandWithParam('_ldsOn')">센서 켜기</button>
        <button onclick="sendCommandWithParam('_ldsOff')">센서 끄기</button>
        <button onclick="sendCommandWithParam('_readLDS')">현재 LDS값 읽기</button>
        <button onclick="sendCommandWithParam('_readSV')">AF STORED VALUE 읽기</button>
        <button onclick="sendCommandWithParam('_writeSV')">AF STORED VALUE 쓰기</button>
        <button onclick="sendCommandWithParam('_IsafOn')">AF on/off상태</button>
        <button onclick="sendCommandWithParam('_afOn')">AF 켜기</button>
        <button onclick="sendCommandWithParam('_afOff')">AF 끄기</button>
        <button onclick="sendCommandWithParam('_readAFworkRange')">AF 작동범위 읽기</button>
        <button onclick="sendCommandWithParam('_writeAFworkRange')">AF 작동범위 쓰기</button>
        <div class="category-title">명령 로그</div>
        <pre id="CmdLogText"></pre>
    </div>

    <div class='tab-content'>
</div>

<div class="tab-content">
        <div class="category-title">캡쳐 이미지</div>
        <div style="text-align:center;">
            <img id="captureImage" src="/image.png" style="max-width:100%; border:1px solid #ccc;" />
            <br />
            <button onclick="refreshCaptureImage()" style="margin-top:10px;">이미지 새로고침</button>
        </div>
        <script>
        function refreshCaptureImage() {
            const img = document.getElementById('captureImage');
            img.src = '/image.png?ts=' + Date.now();
        }
        </script>
</div>


</body>
</html>
